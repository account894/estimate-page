<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>단가 자동 매칭 시스템 (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .btn-text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">단가 자동 매칭 도구 v5.1 (Fixed)</h1>
            <p class="text-slate-600 font-medium text-indigo-600">대용량 데이터(1만행+) 지원 • 엑셀 저장 버그 수정됨</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- 1. 설정 및 업로드 -->
            <div class="md:col-span-1 space-y-6">

                <!-- 시트 선택 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">DB 시트 선택</h2>
                    <select id="sheetSelect" class="w-full border border-slate-300 rounded-lg p-2">
                        <option value="2025년">2025년</option>
                        <option value="세한기업(미완료)">세한기업(미완료)</option>
                        <option value="기타(미완료)">기타(미완료)</option>
                    </select>
                    <div id="dbStatus" class="mt-2 text-sm text-amber-600">DB 상태: 로드 전</div>
                </div>

                <!-- 파일 업로드 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">파일 업로드</h2>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all cursor-pointer border border-slate-200 rounded-lg p-1">
                </div>

                <!-- 실행 버튼 -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700">실행 및 저장</h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="startWorkerMatch()" id="matchBtn" disabled
                            class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 disabled:bg-slate-300 disabled:shadow-none transition-all relative overflow-hidden btn-text-shadow border border-indigo-600">
                            ⚡ 고속 매칭 실행
                        </button>
                        <button onclick="downloadExcel()" id="downloadBtn" disabled
                            class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-emerald-200 hover:bg-emerald-700 disabled:opacity-50 transition-all">
                            엑셀 결과 저장
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. 로그 -->
            <div class="md:col-span-2 space-y-4">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-xl flex flex-col h-[600px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-slate-200 font-semibold">시스템 로그</h2>
                        <button onclick="clearLog()" class="text-xs text-slate-400 hover:text-white uppercase tracking-wider">Clear</button>
                    </div>
                    <div id="log" class="log-container flex-1 text-[13px] font-mono text-green-400 overflow-y-auto whitespace-pre-wrap leading-relaxed"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 -->
    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full mx-4 shadow-2xl border border-slate-100">
            <h3 id="modalTitle" class="text-xl font-bold mb-2 text-slate-800">알림</h3>
            <p id="modalMsg" class="text-slate-600 mb-6 leading-relaxed"></p>
            <button onclick="closeModal()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition-colors">확인</button>
        </div>
    </div>

    <!-- Worker Script (Embedded for Single File functionality) -->
    <script id="worker-script" type="javascript/worker">
        // AI 지식 정의 (동의어 맵)
        const SYNONYM_MAP = {
            "PIPE":"파이프","관":"파이프","SPP":"강관","CARBON STEEL":"강관","흑관":"강관","백관":"강관",
            "SUS":"STS","STAINLESS":"STS","스텐":"STS","스테인리스":"STS",
            "PVC":"PVC","VG1":"PVC","VG2":"PVC","COPPER":"동관","동파이프":"동관",
            "PB":"PB","에이콘":"PB","폴리부틸렌":"PB","CPVC":"CPVC","소방용합성수지":"CPVC",
            "PE":"PE","P.E":"PE","HDPE":"PE","SR":"SR","S.R":"SR",
            "FITTING":"이음쇠","부속":"이음쇠","ELBOW":"엘보","L":"엘보","ELL":"엘보",
            "TEE":"티","T":"티","REDUCER":"레듀샤","RED":"레듀샤","R":"레듀샤","이경소켓":"레듀샤",
            "SOCKET":"소켓","SOC":"소켓","S":"소켓","COUPLING":"소켓",
            "CAP":"캡","마개":"캡","FLANGE":"플랜지","FLG":"플랜지","F":"플랜지",
            "UNION":"유니온","UN":"유니온","U":"유니온","NIPPLE":"니플","N":"니플",
            "BUSHING":"부싱","BUSH":"부싱","ADAPTER":"아답타","M.A":"아답타","F.A":"아답타","ADPT":"아답타",
            "CROSS":"크로스","X":"크로스","SADDLE":"새들","PLUG":"플러그","메꾸라":"플러그",
            "VALVE":"밸브","V/V":"밸브","V.V":"밸브","GATE":"게이트","제수변":"게이트",
            "GLOBE":"글로브","스톱밸브":"글로브","CHECK":"체크","판체크":"체크","스윙체크":"체크",
            "HAMMERLESS":"체크","BALL":"볼","볼밸브":"볼","BUTTERFLY":"버터플라이","B.F":"버터플라이",
            "BFV":"버터플라이","STRAINER":"스트레이너","STR":"스트레이너","Y-STR":"스트레이너",
            "PRV":"감압변","REDUCING":"감압변","SOL":"솔레노이드","SOLENOID":"솔레노이드",
            "AIR VENT":"에어벤트","A.V":"에어벤트","통기":"에어벤트","SAFETY":"안전변","RELIEF":"릴리프",
            "FLOAT":"정수위","F.V":"정수위","HEAD":"헤드","SPRINKLER":"헤드","S.P":"헤드",
            "ALARM":"알람","유수검지":"알람","HYDRANT":"소화전","O.H":"소화전",
            "SIAMESE":"송수구","BOX":"박스","합":"박스","함":"박스","F.BOX":"소화전함",
            "INSULATION":"보온","LAGGING":"보온","RUBBER":"고무발포","아마플렉스":"고무발포",
            "GLASS WOOL":"그라스울","유리솜":"그라스울","HANGER":"행가","CLEVIS":"행가","RING":"행가",
            "SUPPORT":"서포트","지지대":"서포트","ANGLE":"앵글","CHANNEL":"잔넬",
            "BOLT":"볼트","B":"볼트","NUT":"너트","N":"너트","GASKET":"가스켓","PACKING":"가스켓","P.K":"가스켓"
        };

        const INCOMPATIBLE_GROUPS = [
            ["STS","스텐","SUS"],["강관","SPP","백관","흑관"],["PVC","VG1","VG2"],
            ["동관","COPPER"],["PB","에이콘"],["CPVC"],
            ["파이프","관"],
            ["밸브","V/V","게이트","글로브","체크","볼","버터플라이","스트레이너"],
            ["엘보","티","레듀샤","소켓","캡","유니온","부싱","니플","플랜지"],
            ["보온","고무발포","그라스울","매직테이프"],["행가","서포트","절연","슈"],["철거"]
        ];

        const synKeys = Object.keys(SYNONYM_MAP).sort((a,b)=>b.length-a.length);
        const synRegex = new RegExp(synKeys.join("|"),"gi");

        function norm(v){ 
            if(!v) return ""; 
            let str=v.toString().toUpperCase(); 
            str=str.replace(synRegex,(m)=>SYNONYM_MAP[m.toUpperCase()]||m); 
            return str.replace(/[^A-Z0-9가-힣]/g,"").replace(/EA|EACH|개/g,"EA"); 
        }

        function isCategoryMismatch(src,tgt){ 
            for(let i=0;i<INCOMPATIBLE_GROUPS.length;i++){ 
                const group=INCOMPATIBLE_GROUPS[i]; 
                let srcHas=false,tgtHas=false; 
                for(let k=0;k<group.length;k++){ 
                    if(src.includes(group[k])) srcHas=true; 
                    if(tgt.includes(group[k])) tgtHas=true; 
                    if(srcHas && tgtHas) break;
                } 
                if(srcHas!==tgtHas) return true;
            } 
            return false; 
        }

        // 간단한 유사도 점수 계산 (공통 부분 문자열/토큰 기반)
        function calculateScore(srcText, tgtText) {
            if(srcText === tgtText) return 100;
            if(tgtText.includes(srcText)) return 80;
            if(srcText.includes(tgtText)) return 80;
            
            // 2글자 이상 겹치는 토큰 개수
            let score = 0;
            const srcLen = srcText.length;
            const tgtLen = tgtText.length;
            
            // 단순 포함 여부 체크 (최대 50점)
            let matchCount = 0;
            for(let i=0; i<srcLen-1; i++) {
                const sub = srcText.substring(i, i+2);
                if(tgtText.includes(sub)) matchCount++;
            }
            if(matchCount > 0) {
                score = (matchCount / Math.max(srcLen, tgtLen)) * 100;
            }
            
            return score;
        }

        self.onmessage = function(e) {
            const { type, csvRows, dbRows } = e.data;
            if(type !== 'START') return;

            const resultRows = [];
            let conflictCount = 0;
            const total = csvRows.length;
            let lastPercent = 0;

            // DB 데이터 전처리 (검색 속도 향상용)
            const processedDB = dbRows.map(row => ({
                original: row,
                normName: norm(row.A), // 품명
                normSpec: norm(row.B)  // 규격
            }));

            for(let i=0; i < total; i++) {
                // 진행률 보고
                const percent = Math.floor((i / total) * 100);
                if(percent > lastPercent) {
                    self.postMessage({ type: 'PROGRESS', percent });
                    lastPercent = percent;
                }

                const row = csvRows[i];
                // 엑셀 컬럼 인덱스 가정: 0:품명, 1:규격, 2:단위, 3:재료비, 4:노무비... (업로드 파일 형식에 따름)
                // 만약 CSV가 객체 배열이라면 키값으로 접근, 배열이라면 인덱스로 접근
                // 여기서는 XLSX.utils.sheet_to_json(header:1)을 썼으므로 배열임.
                
                const srcName = row[0] || ""; // 품명
                const srcSpec = row[1] || ""; // 규격
                const srcUnit = row[2] || ""; // 단위
                const srcMat = row[3] || 0;
                const srcLab = row[4] || 0;

                const nName = norm(srcName);
                const nSpec = norm(srcSpec);

                if(!nName) {
                    // 빈 행 처리
                    resultRows.push([srcName, srcSpec, srcUnit, srcMat, srcLab, "", "", "", "", "", "", "", "", "", ""]);
                    continue;
                }

                // 매칭 로직
                let candidates = [];
                
                for(let j=0; j < processedDB.length; j++) {
                    const dbItem = processedDB[j];
                    
                    // 1. 카테고리 불일치 즉시 제외
                    if(isCategoryMismatch(nName, dbItem.normName)) continue;

                    // 2. 점수 계산
                    const nameScore = calculateScore(nName, dbItem.normName);
                    const specScore = calculateScore(nSpec, dbItem.normSpec);
                    
                    // 가중치: 품명 60%, 규격 40%
                    const totalScore = (nameScore * 0.6) + (specScore * 0.4);

                    if(totalScore > 30) { // 최소 임계값
                        candidates.push({
                            score: totalScore,
                            item: dbItem.original
                        });
                    }
                }

                // 점수순 정렬
                candidates.sort((a,b) => b.score - a.score);

                // 상위 2개 추출
                const c1 = candidates[0] ? candidates[0].item : {};
                const c2 = candidates[1] ? candidates[1].item : {};

                // 결과 배열 생성 (15 columns)
                // [원본5개] + [후보1 5개] + [후보2 5개]
                const resultRow = [
                    srcName, srcSpec, srcUnit, srcMat, srcLab,
                    c1.A || "", c1.B || "", c1.C || "", c1.D || "", c1.E || "",
                    c2.A || "", c2.B || "", c2.C || "", c2.D || "", c2.E || ""
                ];

                resultRows.push(resultRow);
                if(candidates.length > 1 && (candidates[0].score - candidates[1].score < 5)) {
                    conflictCount++; // 점수차이가 크지 않으면 충돌(검토필요)로 간주
                }
            }

            self.postMessage({ 
                type: 'COMPLETE', 
                resultRows: resultRows, 
                conflictCount: conflictCount 
            });
        };
    </script>

    <script>
        // --- Main JS Code ---
        let dbRows = [];
        let csvRows = [];
        let worker = null;
        let resultRows = [];

        const logEl = document.getElementById("log");
        const matchBtn = document.getElementById("matchBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const dbStatus = document.getElementById("dbStatus");
        const sheetSelect = document.getElementById("sheetSelect");

        // Worker 초기화 (Blob 방식 - 단일 파일 실행 가능)
        function initWorker() {
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            const workerUrl = URL.createObjectURL(blob);
            worker = new Worker(workerUrl);

            worker.onmessage = function(e) {
                const { type, percent, resultRows: res, conflictCount } = e.data;
                
                if(type === 'PROGRESS') {
                    matchBtn.style.background = `linear-gradient(to right, #059669 ${percent}%, #4f46e5 ${percent}%)`;
                    matchBtn.textContent = `⚡ 처리 중... ${percent}%`;
                } else if(type === 'COMPLETE') {
                    resultRows = res; // 결과 저장
                    
                    addLog(`매칭 완료! (충돌 가능성: ${conflictCount}건)`, 'success');
                    matchBtn.disabled = false;
                    matchBtn.style.background = '';
                    matchBtn.textContent = '⚡ 고속 매칭 실행';
                    
                    // 다운로드 버튼 활성화
                    downloadBtn.disabled = false;
                    
                    showMessage("작업 완료", `데이터 처리가 완료되었습니다.\n[결과] 총 ${res.length}행\n[검토필요] 약 ${conflictCount}건`);
                }
            };
        }

        // 로그 유틸리티
        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('ko-KR', {hour12:false});
            let prefix = "●";
            if(type==='success') prefix="✓";
            if(type==='error') prefix="✗";
            
            const div = document.createElement('div');
            div.textContent = `[${time}] ${prefix} ${msg}`;
            if(type === 'error') div.style.color = '#ef4444';
            if(type === 'success') div.style.color = '#34d399';
            
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() { logEl.innerHTML=""; addLog("시스템 준비 완료."); }
        
        function showMessage(title,msg){
            document.getElementById("modalTitle").textContent=title;
            document.getElementById("modalMsg").textContent=msg;
            document.getElementById("modal").classList.remove("hidden");
            document.getElementById("modal").classList.add("flex");
        }
        function closeModal(){
            document.getElementById("modal").classList.add("hidden");
            document.getElementById("modal").classList.remove("flex");
        }

        // DB fetch
        async function fetchDB(){
            const sheetName = sheetSelect.value;
            // 공개된 구글 시트 ID (예시 ID이므로 실제 사용시 확인 필요)
            const SPREADSHEET_ID = "1GaUzextj8jdry2iegBK7EiWDm1VASX8od3o9tP7DoZU";
            const DB_URL = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${encodeURIComponent(sheetName)}`;
            
            matchBtn.disabled = true;
            dbStatus.textContent = "데이터 로딩중...";
            
            try{
                const res = await fetch(DB_URL);
                if(!res.ok) throw new Error("네트워크 응답 오류");
                
                const data = await res.json();
                
                // DB 데이터 매핑 (A:품명, B:규격, C:단위, D:재료비, E:노무비)
                dbRows = data.map(r=>({
                    A: r["품명"]||"",
                    B: r["규격"]||"",
                    C: r["단위"]||"",
                    D: String(r["재료비"]||"0").replace(/,/g,""),
                    E: String(r["노무비"]||"0").replace(/,/g,""),
                    // 검색 편의를 위해 합계 저장 (필요시 사용)
                    totalPrice: Number(String(r["재료비"]||"0").replace(/,/g,"")) + Number(String(r["노무비"]||"0").replace(/,/g,""))
                }));
                
                dbStatus.innerHTML = `✓ DB 준비됨 (${dbRows.length}건)`;
                dbStatus.className = "mt-2 text-sm text-emerald-600 font-semibold";
                addLog(`DB 로드 성공: ${sheetName} (${dbRows.length}행)`, 'success');
                
                if(csvRows.length > 0) matchBtn.disabled=false;
            } catch(err){
                dbStatus.textContent = "DB 로드 실패";
                dbStatus.className = "mt-2 text-sm text-red-600 font-semibold";
                addLog("DB 로드 오류: "+err.message,'error');
            }
        }

        // 시트 변경 이벤트
        sheetSelect.addEventListener("change", fetchDB);

        // 파일 업로드 처리
        document.getElementById("excelFile").addEventListener("change", e=>{
            const file = e.target.files[0];
            if(!file) return;
            
            addLog(`파일 분석 시작: ${file.name}`);
            const reader = new FileReader();
            
            reader.onload = (evt)=>{
                try{
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, {type:'array'});
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // 헤더 포함 전체 데이터를 배열의 배열로 가져옴
                    csvRows = XLSX.utils.sheet_to_json(worksheet, {header:1});
                    
                    addLog(`파일 로드 성공: ${csvRows.length}행`, 'success');
                    
                    if(dbRows.length > 0) matchBtn.disabled=false;
                    else addLog("DB를 먼저 로드해주세요.", 'info');
                    
                } catch(err){ 
                    addLog("파일 파싱 오류: "+err.message, 'error'); 
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // 매칭 시작
        function startWorkerMatch(){
            if(csvRows.length < 2) return showMessage("오류","업로드된 데이터가 없거나 부족합니다.");
            if(dbRows.length === 0) return showMessage("오류","DB가 로드되지 않았습니다.");
            
            addLog("매칭 프로세스 시작...");
            matchBtn.disabled = true;
            downloadBtn.disabled = true;
            
            // 헤더(첫줄) 제외하고 데이터 전달
            const contentRows = csvRows.slice(1);
            worker.postMessage({ type:'START', csvRows: contentRows, dbRows: dbRows });
        }

        // 엑셀 저장 (버그 수정됨)
        function downloadExcel(){
            if(!resultRows || resultRows.length === 0) {
                showMessage("알림", "저장할 결과 데이터가 없습니다.");
                return;
            }

            const header = [
                "품명","규격","단위","재료비","노무비",
                "후보1_품명","후보1_규격","후보1_단위","후보1_재료비","후보1_노무비",
                "후보2_품명","후보2_규격","후보2_단위","후보2_재료비","후보2_노무비"
            ];

            try{
                addLog("엑셀 파일 생성 중...");
                
                // 1. 헤더와 데이터 병합 (데이터가 이미 배열 형식이므로 concat 사용 가능)
                const finalData = [header].concat(resultRows);
                
                // 2. 워크시트 생성
                const ws = XLSX.utils.aoa_to_sheet(finalData);
                
                // 3. 컬럼 너비 설정 (약간 더 넓게 조정)
                ws['!cols'] = Array(15).fill({wch: 18});
                
                // 4. 워크북 생성 및 시트 추가
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "매칭결과");
                
                // 5. 파일 다운로드
                const fileName = `단가매칭결과_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                addLog(`저장 완료: ${fileName}`, 'success');
            } catch(err){ 
                addLog("저장 중 오류 발생: " + err.message, 'error'); 
                console.error(err);
            }
        }

        // 초기화 실행
        initWorker();
        window.onload = fetchDB;

    </script>
</body>
</html>
