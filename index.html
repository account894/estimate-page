<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ëŠ¥í˜• ë§¤ì¹­ ì‹œìŠ¤í…œ v5.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar { width: 6px; }
        .log-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        .btn-text-shadow { text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 mb-2"> SAMJIN ê²¬ì ì‹œìŠ¤í…œ v5.8</h1>
            <p class="text-slate-600 font-medium text-indigo-600"> â€¢ì§€ëŠ¥í˜• ë‹¨ê°€ ê°ì§€</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-6">
                <!-- ì‹œíŠ¸ ì„ íƒ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-all hover:shadow-md">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700 flex items-center">
                        <span class="w-2 h-6 bg-indigo-500 rounded-full mr-2"></span>
                        DB ì‹œíŠ¸
                    </h2>
                    <select id="sheetSelect" class="w-full border border-slate-300 rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        <option value="ì„¸í•œ,ì‹ í•œë©”íƒˆ,ì‹ ì¼,í™”ì„±,ë™ì§„,ì˜ì§„,ì¸ì„±,í”„ëŸ¼íŒŒìŠ¤íŠ¸">í˜‘ë ¥ì‚¬ í†µí•©ë‹¨ê°€</option>
<option value="2025ë…„">2025ë…„ ë‹¨ê°€í‘œ</option>
                        <option value="ckwë‹¨ê°€(ì—…ëƒì˜ˆì •)">ckwë‹¨ê°€(ì ìš©ì˜ˆì •)</option>
                        <option value="ì •ë¶€ë…¸ì„">ì •ë¶€ë…¸ì„</option>
                        <option value="í•œêµ­ë¬¼ê°€ìë£Œkprc">ë¬¼ê°€ìë£Œ BETA test</option>
                    </select>
                    <div id="dbStatus" class="mt-3 text-sm text-amber-600 font-medium">DB ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
                </div>

                <!-- íŒŒì¼ ì—…ë¡œë“œ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-all hover:shadow-md">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700 flex items-center">
                        <span class="w-2 h-6 bg-blue-500 rounded-full mr-2"></span>
                        íŒŒì¼ ì—…ë¡œë“œ
                    </h2>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" 
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all cursor-pointer border border-dashed border-slate-300 rounded-lg p-4">
                    <p class="mt-2 text-[11px] text-slate-400">â€» ê²¬ì  ìš”ì²­í•˜ì‹¤ ë‚´ì—­ì„œë¥¼ ì—…ë¡œë“œí•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                </div>

                <!-- ì‹¤í–‰ ë²„íŠ¼ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 transition-all hover:shadow-md">
                    <h2 class="text-lg font-semibold mb-4 text-slate-700 flex items-center">
                        <span class="w-2 h-6 bg-emerald-500 rounded-full mr-2"></span>
                        ë§¤ì¹­ ì‹¤í–‰
                    </h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="startWorkerMatch()" id="matchBtn" disabled
                            class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-indigo-700 disabled:bg-slate-300 transition-all">
                            âš¡ ê³ ì† ë§¤ì¹­ ì‹¤í–‰
                        </button>
                        <button onclick="downloadExcel()" id="downloadBtn" disabled
                            class="w-full bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg hover:bg-emerald-700 disabled:opacity-50 transition-all">
                            ğŸ“¥ ê²°ê³¼ ì—‘ì…€ ì €ì¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- ëª¨ë‹ˆí„°ë§ ë¡œê·¸ -->
            <div class="md:col-span-2 space-y-4">
                <div class="bg-slate-900 rounded-2xl p-6 shadow-xl flex flex-col h-[640px] border border-slate-800">
                    <div class="flex justify-between items-center mb-4 border-b border-slate-800 pb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <h2 class="text-slate-400 font-mono text-sm ml-2">DATA SYNC MONITOR v5.8</h2>
                        </div>
                        <button onclick="clearLog()" class="text-[11px] text-slate-500 hover:text-white border border-slate-700 px-2 py-1 rounded">Clear</button>
                    </div>
                    <div id="log" class="log-container flex-1 text-[13px] font-mono text-indigo-300 overflow-y-auto whitespace-pre-wrap leading-relaxed px-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Web Worker -->
    <script id="worker-script" type="javascript/worker">
        function normalize(str) {
            if (!str) return "";
            return str.toString().toUpperCase()
                .replace(/\s+/g, "")
                .replace(/[^A-Z0-9ê°€-í£]/g, "")
                .replace(/EA|EACH|ê°œ|SET|ì„¸íŠ¸/g, ""); 
        }

        function getSimilarity(s1, s2) {
            if (!s1 || !s2) return 0;
            if (s1 === s2) return 100;
            const getPairs = (str) => {
                const pairs = new Set();
                for (let i = 0; i < str.length - 1; i++) pairs.add(str.substring(i, i + 2));
                return pairs;
            };
            const pairs1 = getPairs(s1);
            const pairs2 = getPairs(s2);
            if (pairs1.size === 0 || pairs2.size === 0) return 0;
            let intersection = 0;
            pairs1.forEach(p => { if (pairs2.has(p)) intersection++; });
            return (2.0 * intersection) / (pairs1.size + pairs2.size) * 100;
        }

        self.onmessage = function(e) {
            const { csvRows, dbRows, config } = e.data;
            const results = [];
            const THRESHOLD = 50;

            const processedDB = dbRows.map(row => ({
                original: row,
                combined: normalize(row.A + row.B),
                normName: normalize(row.A),
                normSpec: normalize(row.B),
                normUnit: normalize(row.C),
                totalCost: parseFloat(row.D || 0) + parseFloat(row.E || 0)
            }));

            for (let i = 0; i < csvRows.length; i++) {
                const row = csvRows[i];
                const srcName = row[config.nameIdx] || "";
                const srcSpec = row[config.specIdx] || "";
                const srcUnit = row[config.unitIdx] || "";
                
                const rawMat = row[config.matIdx];
                const rawLab = row[config.labIdx];
                const numMat = parseFloat(String(rawMat || "0").replace(/[^0-9.]/g, ""));
                const numLab = parseFloat(String(rawLab || "0").replace(/[^0-9.]/g, ""));
                const isAlreadyPriced = numMat > 0 || numLab > 0;

                if (isAlreadyPriced) {
                    results.push([srcName, srcSpec, srcUnit, rawMat, rawLab, "", "", "", "", "", "", "", "", "", ""]);
                    continue;
                }

                const nCombined = normalize(srcName + srcSpec);
                const nUnit = normalize(srcUnit);
                const nName = normalize(srcName);
                const nSpec = normalize(srcSpec);

                if (!nCombined) {
                    results.push([srcName, srcSpec, srcUnit, 0, 0, "", "", "", "", "", "", "", "", "", ""]);
                    continue;
                }

                // 1. 100% ì¼ì¹˜ í•­ëª©(ì´ë¦„+ê·œê²©+ë‹¨ìœ„) ìˆ˜ì§‘
                const identicalMatches = processedDB.filter(db => db.combined === nCombined && db.normUnit === nUnit);

                let outputRow = [];
                if (identicalMatches.length > 0) {
                    // ì¤‘ë³µëœ ë‹¨ê°€ê°€ ìˆëŠ”ì§€ í™•ì¸
                    const uniquePrices = new Set(identicalMatches.map(m => m.original.D + "|" + m.original.E));
                    
                    if (uniquePrices.size > 1) {
                        // [ì¶©ëŒ ë°œìƒ] - ë‹¨ê°€ê°€ ì—¬ëŸ¬ ê°œì„
                        identicalMatches.sort((a, b) => b.totalCost - a.totalCost);
                        const maxItem = identicalMatches[0].original;
                        const minItem = identicalMatches[identicalMatches.length - 1].original;
                        
                        outputRow = [
                            srcName, srcSpec, srcUnit, "[ì¶©ëŒ]", "[ì¶©ëŒ]",
                            maxItem.A, maxItem.B, maxItem.C, maxItem.D, maxItem.E, // í›„ë³´1: ìµœëŒ“ê°’
                            minItem.A, minItem.B, minItem.C, minItem.D, minItem.E  // í›„ë³´2: ìµœì†Ÿê°’
                        ];
                    } else {
                        // 100% ì¼ì¹˜ ë° ë‹¨ê°€ ë™ì¼ - ìë™ ëŒ€ì…
                        const best = identicalMatches[0].original;
                        outputRow = [
                            srcName, srcSpec, srcUnit, best.D, best.E,
                            "", "", "", "", "",
                            "", "", "", "", ""
                        ];
                    }
                } else {
                    // 100% ì¼ì¹˜ê°€ ì—†ì„ ê²½ìš° - ìœ ì‚¬ë„ ë§¤ì¹­ ìˆ˜í–‰
                    let candidates = [];
                    for (let j = 0; j < processedDB.length; j++) {
                        const db = processedDB[j];
                        const nameSim = getSimilarity(nName, db.normName);
                        const specSim = getSimilarity(nSpec, db.normSpec);
                        const unitSim = (nUnit === db.normUnit && nUnit !== "") ? 100 : 0;
                        const totalScore = (nameSim * 0.5) + (specSim * 0.3) + (unitSim * 0.2);
                        if (totalScore >= THRESHOLD) candidates.push({ score: totalScore, item: db.original });
                    }
                    candidates.sort((a, b) => b.score - a.score);
                    const c1 = candidates[0] ? candidates[0].item : {};
                    const c2 = candidates[1] ? candidates[1].item : {};
                    outputRow = [
                        srcName, srcSpec, srcUnit, 0, 0,
                        c1.A || "", c1.B || "", c1.C || "", c1.D || "", c1.E || "",
                        c2.A || "", c2.B || "", c2.C || "", c2.D || "", c2.E || ""
                    ];
                }

                results.push(outputRow);
                if (i % 100 === 0) self.postMessage({ type: 'PROGRESS', percent: Math.floor((i / csvRows.length) * 100) });
            }
            self.postMessage({ type: 'COMPLETE', results });
        };
    </script>

    <script>
        let dbRows = [];
        let csvRows = [];
        let resultRows = [];
        let colConfig = { nameIdx: 0, specIdx: 1, unitIdx: 2, matIdx: 3, labIdx: 4 };

        const logEl = document.getElementById("log");
        const matchBtn = document.getElementById("matchBtn");
        const downloadBtn = document.getElementById("downloadBtn");
        const dbStatus = document.getElementById("dbStatus");

        function addLog(msg, type='info') {
            const time = new Date().toLocaleTimeString('ko-KR', {hour12:false});
            const color = type === 'success' ? 'text-emerald-400' : (type === 'error' ? 'text-rose-400' : 'text-indigo-300');
            const div = document.createElement('div');
            div.className = `mb-1 border-l-2 pl-2 ${type==='error'?'border-red-500':'border-indigo-500'}`;
            div.innerHTML = `<span class="text-slate-600 text-[11px] mr-2">${time}</span><span class="${color}">${msg}</span>`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() { logEl.innerHTML = ""; }

        function parsePrice(val) {
            if (val === null || val === undefined || val === "") return "0";
            const clean = String(val).replace(/[^0-9.]/g, "");
            return clean === "" ? "0" : clean;
        }

        function getValueByKeywords(obj, keywords) {
            const keys = Object.keys(obj);
            const foundKey = keys.find(k => {
                const cleanK = k.replace(/\s+/g, "");
                return keywords.some(kw => cleanK.includes(kw));
            });
            return foundKey ? obj[foundKey] : null;
        }

        async function fetchDB() {
            const sheetName = document.getElementById("sheetSelect").value;
            const SPREADSHEET_ID = "1GaUzextj8jdry2iegBK7EiWDm1VASX8od3o9tP7DoZU";
            const DB_URL = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${encodeURIComponent(sheetName)}`;
            
            dbStatus.textContent = "âŒ› ë°ì´í„° ë™ê¸°í™” ì¤‘...";
            dbStatus.className = "mt-3 text-sm text-indigo-500 font-medium animate-pulse-soft";
            
            try {
                const res = await fetch(DB_URL);
                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) throw new Error("ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                dbRows = data.map(r => ({
                    A: getValueByKeywords(r, ["í’ˆëª…", "í’ˆëª©", "ì´ë¦„"]) || "",
                    B: getValueByKeywords(r, ["ê·œê²©", "ì‚¬ì´ì¦ˆ"]) || "",
                    C: getValueByKeywords(r, ["ë‹¨ìœ„"]) || "",
                    D: parsePrice(getValueByKeywords(r, ["ì¬ë£Œë¹„", "ì¬ë£Œ", "ë‹¨ê°€"])),
                    E: parsePrice(getValueByKeywords(r, ["ë…¸ë¬´ë¹„", "ë…¸ë¬´"]))
                }));

                dbStatus.innerHTML = `âœ“ ê²¬ì ì‹œìŠ¤í…œ v5.8 ì¤€ë¹„ ì™„ë£Œ`;
                dbStatus.className = "mt-3 text-sm text-emerald-600 font-bold";
                addLog(`DB ë¡œë“œ ì„±ê³µ: [${sheetName}]`, 'success');
                if(csvRows.length > 0) matchBtn.disabled = false;
            } catch (err) {
                dbStatus.textContent = "âŒ ì—°ë™ ì‹¤íŒ¨";
                addLog("DB ë¡œë”© ì—ëŸ¬: " + err.message, 'error');
            }
        }

        document.getElementById("excelFile").addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    csvRows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    const header = csvRows[0].map(h => String(h || "").replace(/\s+/g, ""));
                    colConfig.nameIdx = header.findIndex(h => h.includes("í’ˆëª…") || h.includes("í’ˆëª©")) !== -1 ? header.findIndex(h => h.includes("í’ˆëª…") || h.includes("í’ˆëª©")) : 0;
                    colConfig.specIdx = header.findIndex(h => h.includes("ê·œê²©")) !== -1 ? header.findIndex(h => h.includes("ê·œê²©")) : 1;
                    colConfig.unitIdx = header.findIndex(h => h.includes("ë‹¨ìœ„")) !== -1 ? header.findIndex(h => h.includes("ë‹¨ìœ„")) : 2;
                    colConfig.matIdx = header.findIndex(h => h.includes("ì¬ë£Œ")) !== -1 ? header.findIndex(h => h.includes("ì¬ë£Œ")) : 3;
                    colConfig.labIdx = header.findIndex(h => h.includes("ë…¸ë¬´")) !== -1 ? header.findIndex(h => h.includes("ë…¸ë¬´")) : 4;

                    addLog(`íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${csvRows.length}í–‰`, 'success');
                    if(dbRows.length > 0) matchBtn.disabled = false;
                } catch (err) { addLog("íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: " + err.message, 'error'); }
            };
            reader.readAsArrayBuffer(file);
        });

        function startWorkerMatch() {
            matchBtn.disabled = true;
            addLog("ê³ ì† ë§¤ì¹­ í”„ë¡œì„¸ìŠ¤ ê°€ë™ (ë‹¨ê°€ ì¶©ëŒ ê°ì§€ í™œì„±í™”)...");
            const blob = new Blob([document.getElementById('worker-script').textContent], { type: "text/javascript" });
            const worker = new Worker(URL.createObjectURL(blob));
            
            worker.postMessage({ 
                csvRows: csvRows.slice(1), 
                dbRows: dbRows,
                config: colConfig 
            });

            worker.onmessage = function(e) {
                if (e.data.type === 'PROGRESS') {
                    matchBtn.textContent = `ì²˜ë¦¬ì¤‘... ${e.data.percent}%`;
                } else if (e.data.type === 'COMPLETE') {
                    resultRows = e.data.results;
                    addLog(`ë§¤ì¹­ ì™„ë£Œ! `, 'success');
                    matchBtn.disabled = false;
                    matchBtn.textContent = "âš¡ ê³ ì† ë§¤ì¹­ ì‹¤í–‰";
                    downloadBtn.disabled = false;
                    worker.terminate();
                }
            };
        }

        function downloadExcel() {
            if (resultRows.length === 0) return;
            const header = ["ëŒ€ìƒ_í’ˆëª…","ëŒ€ìƒ_ê·œê²©","ëŒ€ìƒ_ë‹¨ìœ„","ëŒ€ìƒ_ì¬ë£Œë¹„","ëŒ€ìƒ_ë…¸ë¬´ë¹„","í›„ë³´1_í’ˆëª…","í›„ë³´1_ê·œê²©","í›„ë³´1_ë‹¨ìœ„","í›„ë³´1_ì¬ë£Œë¹„","í›„ë³´1_ë…¸ë¬´ë¹„","í›„ë³´2_í’ˆëª…","í›„ë³´2_ê·œê²©","í›„ë³´2_ë‹¨ìœ„","í›„ë³´2_ì¬ë£Œë¹„","í›„ë³´2_ë…¸ë¬´ë¹„"];
            const ws = XLSX.utils.aoa_to_sheet([header, ...resultRows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "MatchResult");
            XLSX.writeFile(wb, `ë§¤ì¹­ê²°ê³¼_v5.8_${new Date().getTime()}.xlsx`);
            addLog("ê²°ê³¼ íŒŒì¼ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.", 'success');
        }

        document.getElementById("sheetSelect").addEventListener("change", fetchDB);
        window.onload = fetchDB;
    </script>
</body>
</html>
